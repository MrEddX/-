<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <title>–ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä –ö–∞—Å–æ–≤–∞ –ù–∞–ª–∏—á–Ω–æ—Å—Ç (c) 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #334155;
            --accent: #3b82f6;
            --border: #e2e8f0;
            --header-bg: #ffffff;
            --hover-bg: #f1f5f9;
            --shadow: 0 10px 40px rgba(0,0,0,0.06);
            --btn-save-bg: #dcfce7;
            --btn-save-text: #16a34a;
            --btn-save-border: #bbf7d0;
            --btn-clear-bg: #fee2e2;
            --btn-clear-text: #dc2626;
            --btn-clear-border: #fecaca;
            --operator-bg: #f8fafc;
        }

        .dark-mode {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
            --accent: #60a5fa;
            --border: #334155;
            --header-bg: #1e293b;
            --hover-bg: #2d3a4f;
            --shadow: 0 10px 40px rgba(0,0,0,0.3);
            --btn-save-bg: #14532d;
            --btn-save-text: #86efac;
            --btn-save-border: #166534;
            --btn-clear-bg: #7f1d1d;
            --btn-clear-text: #fca5a5;
            --btn-clear-border: #991b1b;
            --operator-bg: #1e293b;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            scroll-behavior: smooth;
            transition: background-color 0.3s ease, color 0.2s ease;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 40px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            color: var(--text);
            z-index: 1001;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
        }

        .theme-toggle:hover { transform: scale(1.05); background: var(--hover-bg); }
        .theme-toggle .sun { display: inline; }
        .theme-toggle .moon { display: none; }
        .dark-mode .theme-toggle .sun { display: none; }
        .dark-mode .theme-toggle .moon { display: inline; }

        .page-calc {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .app-container {
            background: var(--card);
            padding: 25px 35px;
            border-radius: 24px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 1100px;
            border: 1px solid var(--border);
            transition: background-color 0.3s ease, border-color 0.2s ease;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
        }
        .dark-mode header { border-bottom: 2px solid var(--border); }

        #clock { font-size: 1.4em; font-weight: 800; color: var(--accent); }

        .operator-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 8px 12px;
            background: var(--operator-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
        }
        .operator-row label { font-size: 0.95em; display: flex; align-items: center; gap: 8px; color: #64748b; }
        .operator-row input {
            width: 200px; padding: 8px 12px; border: 1px solid var(--border);
            border-radius: 6px; font-weight: normal; font-size: 0.95em;
            background: var(--bg); color: var(--text);
        }
        .operator-row input:focus { outline: none; border-color: var(--accent); }

        .shift-badge { background: var(--accent); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; }

        .main-grid { display: grid; grid-template-columns: 1fr 1fr 1.3fr; gap: 25px; }
        .column { display: flex; flex-direction: column; gap: 6px; }
        .col-header { font-size: 0.75em; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 5px; }

        .row {
            display: flex; align-items: center; padding: 6px 12px;
            border-radius: 10px; border: 1px solid var(--border); background: var(--card);
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .label { flex: 1; font-weight: 700; font-size: 0.95em; }

        input {
            width: 85px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px;
            text-align: center; font-weight: bold; font-size: 1.1em;
            background: var(--bg); color: var(--text); transition: all 0.2s ease;
        }
        .dark-mode input { border: 1px solid var(--border); }
        input:focus { outline: none; border-color: var(--accent); background: #f0f7ff; }
        .dark-mode input:focus { background: var(--hover-bg); }

        .b500 { border-left: 6px solid #a29bfe; background: #f5f3ff; }
        .b200 { border-left: 6px solid #fbc531; background: #fffbeb; }
        .b100 { border-left: 6px solid #4cd137; background: #f0fdf4; }
        .b50  { border-left: 6px solid #e67e22; background: #fff7ed; }
        .b20  { border-left: 6px solid #3498db; background: #eff6ff; }
        .b10  { border-left: 6px solid #e84118; background: #fef2f2; }
        .b5   { border-left: 6px solid #95a5a6; background: #f8fafc; }
        .gold   { border-left: 6px solid #d4af37; background: #fffdf0; }
        .copper { border-left: 6px solid #b87333; background: #fff7f2; }

        .dark-mode .b500   { background: #2d2b4a; }
        .dark-mode .b200   { background: #3d3a24; }
        .dark-mode .b100   { background: #1d3a2a; }
        .dark-mode .b50    { background: #3d3422; }
        .dark-mode .b20    { background: #1d3347; }
        .dark-mode .b10    { background: #3d2427; }
        .dark-mode .b5     { background: #2d3338; }
        .dark-mode .gold   { background: #3d3925; }
        .dark-mode .copper { background: #3d2e26; }

        .right-panel { background: #f8fafc; padding: 18px; border-radius: 18px; border: 1px solid var(--border); }
        .dark-mode .right-panel { background: var(--card); }
        .extra-box { margin-bottom: 12px; }
        .special-label { font-size: 0.75em; font-weight: 700; display: block; margin-bottom: 4px; }
        .full-in { width: 100% !important; box-sizing: border-box; padding: 10px; font-size: 1.3em; }

        .summary-footer {
            margin-top: 20px; padding-top: 20px; border-top: 2px solid #f1f5f9;
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;
        }
        .dark-mode .summary-footer { border-top: 2px solid var(--border); }
        .stat-card { padding: 12px; border-radius: 15px; border: 1px solid var(--border); background: var(--card); text-align: center; }
        .res-val { font-size: 1.8em; font-weight: 900; }
        .diff-pos { color: #16a34a; }
        .diff-neg { color: #dc2626; }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        .btn { padding: 14px; border-radius: 12px; cursor: pointer; font-weight: bold; border: 1px solid transparent; transition: 0.2s; font-size: 0.9em; }
        .btn-save { background: var(--btn-save-bg); color: var(--btn-save-text); border-color: var(--btn-save-border); }
        .btn-clear { background: var(--btn-clear-bg); color: var(--btn-clear-text); border-color: var(--btn-clear-border); }

        #help-modal, #toast, #confirm-modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--card); padding: 30px; border-radius: 20px;
            box-shadow: var(--shadow); z-index: 1000; border: 2px solid var(--accent); color: var(--text);
        }
        #toast {
            padding: 20px 40px; border-color: #16a34a; color: #16a34a;
            font-weight: bold; font-size: 1.2em; text-align: center;
        }
        .dark-mode #toast { background: var(--card); }

        /* Custom confirm modal ‚Äì replaces blocking browser confirm() */
        #confirm-modal { min-width: 320px; max-width: 90vw; text-align: center; }
        #confirm-modal h3 { margin-top: 0; }
        #confirm-modal p { margin: 10px 0 20px 0; }
        .confirm-btns { display: flex; gap: 10px; justify-content: center; }
        .confirm-btns button { padding: 10px 24px; border-radius: 10px; font-weight: bold; cursor: pointer; border: none; font-size: 0.95em; }
        #confirm-ok { background: var(--accent); color: white; }
        #confirm-cancel { background: var(--hover-bg); color: var(--text); border: 1px solid var(--border) !important; }
        #modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 999;
        }

        .kb-key { background: #f1f5f9; padding: 2px 8px; border-radius: 5px; border: 1px solid #cbd5e1; font-family: monospace; font-weight: bold; }
        .dark-mode .kb-key { background: var(--hover-bg); border-color: var(--border); }

        .nav-hint {
            position: fixed; right: 30px; bottom: 30px; background: var(--card);
            padding: 12px; border-radius: 50%; box-shadow: var(--shadow);
            border: 1px solid var(--border); z-index: 100; cursor: pointer;
        }

        .page-history {
            min-height: 100vh; background: var(--bg); display: flex;
            flex-direction: column; align-items: center; padding: 60px 20px;
            border-top: 4px solid var(--accent);
        }
        .history-container { width: 100%; max-width: 1200px; }
        .scroll-box { max-height: 600px; overflow-y: auto; border: 1px solid var(--border); border-radius: 15px; margin-top: 20px; background: var(--card); }

        table { width: 100%; border-collapse: collapse; }
        th { position: sticky; top: 0; background: var(--card); padding: 15px; text-align: left; border-bottom: 2px solid var(--border); color: var(--text); font-size: 0.9em; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); color: var(--text); font-size: 0.85em; white-space: nowrap; }
        .operator-badge { background: var(--accent); color: white; padding: 2px 6px; border-radius: 20px; font-size: 0.75em; font-weight: bold; display: inline-block; }

        #importFile { display: none; }

        .checkbox-column { width: 40px; text-align: center; }
        .history-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }
        .history-row-selected { background-color: rgba(59, 130, 246, 0.1) !important; }
        .dark-mode .history-row-selected { background-color: rgba(96, 165, 250, 0.2) !important; }
        .select-all-btn { cursor: pointer; background: var(--card); border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; color: var(--text); font-weight: bold; font-size: 0.85em; transition: all 0.2s ease; }
        .select-all-btn:hover { background: var(--hover-bg); }
        .delete-selected-btn { background: #dc2626 !important; color: white !important; border-color: #b91c1c !important; }
        .delete-selected-btn:hover { background: #b91c1c !important; }

        @media print {
            .page-calc, .nav-hint, .btn-group, .theme-toggle, #help-modal, #toast, .history-container button { display: none !important; }
            .page-history { border: none; padding: 0; background: white; }
            .scroll-box { max-height: none; overflow: visible; border: none; }
            table { font-size: 9pt; border: 1px solid #eee; width: 100%; }
            th, td { color: black; padding: 4px 6px; font-size: 8pt; white-space: nowrap; }
            .operator-badge { font-size: 7pt; padding: 1px 4px; }
            .checkbox-column, .history-checkbox, .select-all-btn { display: none !important; }
        }

        @media screen and (max-width: 1000px) {
            .app-container { padding: 20px; max-width: 95%; }
            .main-grid { gap: 15px; }
            input { width: 70px; font-size: 1em; }
            .full-in { font-size: 1.1em; }
            .operator-row input { width: 150px; }
        }
        @media screen and (max-width: 700px) {
            .app-container { padding: 15px 12px; }
            .main-grid { gap: 10px; }
            .row { padding: 4px 8px; }
            .label { font-size: 0.85em; }
            input { width: 60px; padding: 6px; font-size: 0.9em; }
            .full-in { font-size: 1em; padding: 8px; }
            .operator-row { padding: 5px 8px; }
            .operator-row input { width: 120px; padding: 6px 8px; }
            .shift-badge { font-size: 0.75em; padding: 3px 8px; }
            .summary-footer { gap: 10px; }
            .stat-card { padding: 8px; }
            .res-val { font-size: 1.4em; }
            .btn-group { gap: 8px; }
            .btn { padding: 12px; font-size: 0.85em; }
        }
        @media screen and (max-width: 500px) {
            .app-container { padding: 10px 8px; }
            .main-grid { gap: 8px; }
            .col-header { font-size: 0.65em; }
            .row { padding: 3px 5px; }
            .label { font-size: 0.75em; }
            input { width: 50px; padding: 4px; font-size: 0.8em; }
            .full-in { font-size: 0.9em; padding: 6px; }
            .operator-row { padding: 4px 6px; }
            .operator-row label { font-size: 0.8em; }
            .operator-row input { width: 100px; padding: 5px 6px; font-size: 0.8em; }
            .shift-badge { font-size: 0.65em; padding: 2px 6px; }
            .summary-footer { gap: 5px; }
            .stat-card { padding: 5px; }
            .special-label { font-size: 0.65em; }
            .res-val { font-size: 1.1em; }
            .btn-group { gap: 5px; margin-top: 5px; }
            .btn { padding: 8px; font-size: 0.75em; }
        }
        @media screen and (min-width: 1600px) {
            .app-container { max-width: 1300px; padding: 30px 45px; }
            .main-grid { gap: 35px; }
            .row { padding: 8px 16px; }
            .label { font-size: 1.1em; }
            input { width: 100px; padding: 10px; font-size: 1.3em; }
            .full-in { font-size: 1.5em; }
            .res-val { font-size: 2.2em; }
            .btn { padding: 16px; font-size: 1em; }
        }
    </style>
</head>
<body>

<!-- Overlay –∑–∞ confirm –º–æ–¥–∞–ª–∞ -->
<div id="modal-overlay" onclick="confirmCancel()"></div>

<!-- –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–∏ confirm –º–æ–¥–∞–ª ‚Äì –∑–∞–º–µ—Å—Ç–≤–∞ blocking confirm()/alert() -->
<div id="confirm-modal">
    <h3 id="confirm-title">–ü–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ</h3>
    <p id="confirm-message"></p>
    <div class="confirm-btns">
        <button id="confirm-ok" onclick="confirmOK()">–î–ê</button>
        <button id="confirm-cancel" onclick="confirmCancel()">–û–¢–ö–ê–ó</button>
    </div>
</div>

<!-- –ë—É—Ç–æ–Ω –∑–∞ —Å–º—è–Ω–∞ –Ω–∞ —Ç–µ–º–∞—Ç–∞ -->
<div class="theme-toggle" onclick="toggleTheme()">
    <span class="sun">üåô</span>
    <span class="moon">‚òÄÔ∏è</span>
    <span id="theme-text">–¢—ä–º–Ω–∞</span>
</div>

<!-- –ü–æ–º–æ—â–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü -->
<div id="help-modal">
    <h2 style="margin-top:0; text-align:center">–ü–æ–º–æ—â</h2>
    <h3 style="margin-top:0">‚å®Ô∏è –ë—ä—Ä–∑–∏ –∫–ª–∞–≤–∏—à–∏</h3>
    <p><span class="kb-key">F1</span> - –ü–æ–º–æ—â - —Ç–æ–∑–∏ –ø—Ä–æ–∑–æ—Ä–µ—Ü</p>
    <p><span class="kb-key">Enter</span> - –í—ä–≤–µ–∂–¥–∞ –∏ –ø—Ä–µ–º–∏–Ω–∞–≤–∞ –∫—ä–º —Å–ª–µ–¥–≤–∞—â–æ –ø–æ–ª–µ</p>
    <p><span class="kb-key">Page Up</span> - –ö—ä–º –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä–∞</p>
    <p><span class="kb-key">Page Down</span> - –ö—ä–º –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</p>
    <p><span class="kb-key">Ctrl + Enter</span> - –ó–∞–ø–∏—Å –≤ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</p>
    <p><span class="kb-key">Esc</span> - –ò–∑—á–∏—Å—Ç–≤–∞/–ó–∞—Ç–≤–∞—Ä—è</p>
    <p><span class="kb-key">Alt + P</span> - –ü—Ä–∏–Ω—Ç–∏—Ä–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è</p>
    <p><span class="kb-key">Alt + S</span> - –ï–∫—Å–ø–æ—Ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –≤ JSON —Ñ–∞–π–ª</p>
    <p><span class="kb-key">Ctrl + Insert</span> - –ò–º–ø–æ—Ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –æ—Ç JSON —Ñ–∞–π–ª</p>
    <p><span class="kb-key">Ctrl + Delete</span> - –ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞ –∏ –∏–∑—Ç—Ä–∏–≤–∞ —Ü—è–ª–∞—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è</p>
    <button onclick="toggleHelp()" style="width:100%; padding:10px; cursor:pointer; border-radius:10px; background: var(--accent); color: white; border: none; font-weight: bold;">–ó–∞—Ç–≤–æ—Ä–∏</button>
    <hr style="border: none; border-top: 1px solid var(--border); margin: 15px 0 10px 0; opacity:0.5;">
    <p style="margin:5px 0 0 0; text-align:center; font-size:0.85em; color: var(--text); opacity:0.7;">–û—Ç—á–µ—Ç –ö–∞—Å–∞ –≤–µ—Ä—Å–∏—è 2.0 (c) 2026</p>
    <p style="margin:2px 0 0 0; text-align:center; font-size:0.8em;">
        <!-- FIX: rel="noopener noreferrer" added to prevent window.opener exploit -->
        <a href="https://github.com/MrEddX/daily-cash-register-reports/releases/latest" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none; opacity:0.8;">üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –Ω–æ–≤–∞ –≤–µ—Ä—Å–∏—è</a>
    </p>
</div>

<div id="toast"></div>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<div id="btnNav" class="nav-hint" onclick="togglePage()">
    <svg id="svgDown" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M7 13l5 5 5-5M7 6l5 5 5-5"/></svg>
    <svg id="svgUp" style="display:none" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M17 11l-5-5-5 5M17 18l-5-5-5 5"/></svg>
</div>

<!-- –û—Å–Ω–æ–≤–µ–Ω –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä -->
<div class="page-calc">
    <div class="app-container">
        <header>
            <h2 style="margin:0">üí∂ –ö–∞—Å–æ–≤–∞ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç <span style="font-size:0.4em; opacity:0.4">–ü–æ–º–æ—â (F1)</span></h2>
            <div style="text-align:right">
                <div id="date" style="font-size:0.8em; color:#64748b">-- -- ----</div>
                <div id="clock">00:00:00</div>
            </div>
        </header>

        <div class="operator-row">
            <label>
                <span>–û–ø–µ—Ä–∞—Ç–æ—Ä / –ö–∞—Å–∏–µ—Ä:</span>
                <input type="text" id="operator-name" placeholder="–ò–º–µ –Ω–∞ –∫–∞—Å–∏–µ—Ä–∞" value="–ì–æ—Å—Ç" maxlength="50">
            </label>
            <span class="shift-badge" id="shift-display">–ü—ä—Ä–≤–∞ —Å–º—è–Ω–∞</span>
        </div>

        <div class="main-grid">
            <!-- –ë–∞–Ω–∫–Ω–æ—Ç–∏ -->
            <div class="column">
                <div class="col-header">–ë–∞–Ω–∫–Ω–æ—Ç–∏</div>
                <div class="row b500"><span class="label">500 ‚Ç¨</span><input type="text" id="first-input" class="c-in" data-v="500" inputmode="numeric"></div>
                <div class="row b200"><span class="label">200 ‚Ç¨</span><input type="text" class="c-in" data-v="200" inputmode="numeric"></div>
                <div class="row b100"><span class="label">100 ‚Ç¨</span><input type="text" class="c-in" data-v="100" inputmode="numeric"></div>
                <div class="row b50"><span class="label">50 ‚Ç¨</span><input type="text" class="c-in" data-v="50" inputmode="numeric"></div>
                <div class="row b20"><span class="label">20 ‚Ç¨</span><input type="text" class="c-in" data-v="20" inputmode="numeric"></div>
                <div class="row b10"><span class="label">10 ‚Ç¨</span><input type="text" class="c-in" data-v="10" inputmode="numeric"></div>
                <div class="row b5"><span class="label">5 ‚Ç¨</span><input type="text" class="c-in" data-v="5" inputmode="numeric"></div>
            </div>
            <!-- –ú–æ–Ω–µ—Ç–∏ -->
            <div class="column">
                <div class="col-header">–ú–æ–Ω–µ—Ç–∏</div>
                <div class="row gold"><span class="label">2 ‚Ç¨</span><input type="text" class="c-in" data-v="2" inputmode="numeric"></div>
                <div class="row gold"><span class="label">1 ‚Ç¨</span><input type="text" class="c-in" data-v="1" inputmode="numeric"></div>
                <div class="row gold"><span class="label">0.50 ‚Ç¨</span><input type="text" class="c-in" data-v="0.5" inputmode="numeric"></div>
                <div class="row gold"><span class="label">0.20 ‚Ç¨</span><input type="text" class="c-in" data-v="0.2" inputmode="numeric"></div>
                <div class="row gold"><span class="label">0.10 ‚Ç¨</span><input type="text" class="c-in" data-v="0.1" inputmode="numeric"></div>
                <div class="row copper"><span class="label">0.05 ‚Ç¨</span><input type="text" class="c-in" data-v="0.05" inputmode="numeric"></div>
                <div class="row copper"><span class="label">0.02 ‚Ç¨</span><input type="text" class="c-in" data-v="0.02" inputmode="numeric"></div>
                <div class="row copper"><span class="label">0.01 ‚Ç¨</span><input type="text" class="c-in" data-v="0.01" inputmode="numeric"></div>
            </div>
            <!-- –ö–æ—Ä–µ–∫—Ü–∏–∏ -->
            <div class="column right-panel">
                <div class="col-header">–ö–æ—Ä–µ–∫—Ü–∏–∏</div>
                <div class="extra-box"><span class="special-label" style="color:#16a34a">–ü–ª—é—Å (+):</span><input type="text" id="plus-in" class="full-in" inputmode="decimal"></div>
                <div class="extra-box"><span class="special-label" style="color:#dc2626">–ú–∏–Ω—É—Å (-):</span><input type="text" id="minus-in" class="full-in" inputmode="decimal"></div>
                <div class="extra-box"><span class="special-label" style="color:#6366f1">POS (–ü–ª–∞—â–∞–Ω–∏—è —Å –∫–∞—Ä—Ç–∞):</span><input type="text" id="pos-in" class="full-in" inputmode="decimal"></div>
                <div class="extra-box"><span class="special-label" style="color:var(--accent)">X-–û—Ç—á–µ—Ç (–ë–µ–∑ –Ω—É–ª–∏—Ä–∞–Ω–µ):</span><input type="text" id="reg-in" class="full-in" inputmode="decimal"></div>
                <div class="btn-group">
                    <button class="btn btn-save" onclick="saveHistory()">–ó–ê–ü–ò–®–ò</button>
                    <button class="btn btn-clear" onclick="clearAll()">–ò–ó–ß–ò–°–¢–ò</button>
                </div>
            </div>
        </div>

        <div class="summary-footer">
            <div class="stat-card"><span class="special-label">–í –ë—Ä–æ–π:</span><span class="res-val" id="total-cash">0.00 ‚Ç¨</span></div>
            <div class="stat-card"><span class="special-label">–û–±—â –û–±–æ—Ä–æ—Ç:</span><span class="res-val" id="day-total">0.00 ‚Ç¨</span></div>
            <div class="stat-card"><span class="special-label">–†–∞–∑–ª–∏–∫–∞:</span><span class="res-val" id="diff-display">0.00 ‚Ç¨</span></div>
        </div>
    </div>
</div>

<!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏—Å—Ç–æ—Ä–∏—è -->
<div class="page-history">
    <div class="history-container">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 15px;">
            <h2 style="margin:0">üìú –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –æ—Ç—á–µ—Ç–∏—Ç–µ</h2>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="exportToJSON()" style="cursor:pointer; background:#e0f2fe; border:1px solid #bae6fd; padding: 8px 12px; border-radius: 8px; color:#0369a1; font-weight: bold;">‚¨á –ï–ö–°–ü–û–†–¢</button>
                <button onclick="document.getElementById('importFile').click()" style="cursor:pointer; background:#fef9c3; border:1px solid #fde047; padding: 8px 12px; border-radius: 8px; color:#854d0e; font-weight: bold;">üìÇ –ò–ú–ü–û–†–¢</button>
                <button onclick="printHistory()" style="cursor:pointer; background:#f1f5f9; border:1px solid #cbd5e1; padding: 8px 12px; border-radius: 8px; color:#334155; font-weight: bold;">üñ® –ü–†–ò–ù–¢</button>
                <button onclick="deleteHistory()" style="cursor:pointer; background:#fff1f2; border:1px solid #fecdd3; padding: 8px 12px; border-radius: 8px; color:#be123c; font-weight: bold;" id="delete-btn">üóë –ò–ó–¢–†–ò–ô</button>
                <button onclick="toggleSelectAll()" class="select-all-btn" id="select-all-btn">‚úì –ú–ê–†–ö–ò–†–ê–ô –í–°–ò–ß–ö–û</button>
                <input type="file" id="importFile" accept=".json" onchange="importFromJSON(event)">
            </div>
        </div>
        <div class="scroll-box">
            <table id="historyTable">
                <thead>
                    <tr>
                        <th class="checkbox-column"><input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()"></th>
                        <th>–î–∞—Ç–∞ / –ß–∞—Å</th>
                        <th>–ö–∞—Å–∏–µ—Ä</th>
                        <th>–°–º—è–Ω–∞</th>
                        <th>–í –±—Ä–æ–π</th>
                        <th>–ö–∞—Ä—Ç–∏</th>
                        <th>X-–û—Ç—á–µ—Ç</th>
                        <th>–†–∞–∑–ª–∏–∫–∞</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FIX 1 ‚Äì XSS prevention: escape all user/stored data before
    //          inserting into innerHTML or document.write()
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function escapeHTML(str) {
        return String(str == null ? '' : str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FIX 2 ‚Äì Replace blocking alert()/confirm() with a custom modal
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let _confirmCallback = null;
    function showConfirm(title, message, onOK) {
        _confirmCallback = onOK;
        // textContent is XSS-safe; no HTML parsing
        document.getElementById('confirm-title').textContent   = title;
        document.getElementById('confirm-message').textContent = message;
        document.getElementById('confirm-modal').style.display  = 'block';
        document.getElementById('modal-overlay').style.display  = 'block';
    }
    function confirmOK() {
        document.getElementById('confirm-modal').style.display = 'none';
        document.getElementById('modal-overlay').style.display = 'none';
        if (_confirmCallback) { _confirmCallback(); _confirmCallback = null; }
    }
    function confirmCancel() {
        document.getElementById('confirm-modal').style.display = 'none';
        document.getElementById('modal-overlay').style.display = 'none';
        _confirmCallback = null;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FIX 3 ‚Äì Validate structure of every record before import/use
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const REQUIRED_FIELDS = ['time','operator','shift','cash','pos','reg','diff'];
    function isValidRecord(h) {
        if (typeof h !== 'object' || h === null) return false;
        for (const f of REQUIRED_FIELDS) {
            if (!(f in h) || typeof h[f] !== 'string' || h[f].length > 200) return false;
        }
        return true;
    }
    // Sanitize a raw record (escape + length-limit every field)
    function sanitizeRecord(h) {
        return {
            time:       escapeHTML(h.time).substring(0, 40),
            operator:   escapeHTML(h.operator).substring(0, 50),
            shift:      escapeHTML(h.shift).substring(0, 20),
            cash:       escapeHTML(h.cash).substring(0, 30),
            pos:        escapeHTML(h.pos).substring(0, 20),
            reg:        escapeHTML(h.reg).substring(0, 20),
            diff:       escapeHTML(h.diff).substring(0, 30),
            // FIX 6: keep numeric diff for reliable sign checks
            diffValue:  typeof h.diffValue === 'number' ? h.diffValue : 0
        };
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // App state
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let selectedRows = new Set();

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        document.getElementById('theme-text').textContent = isDark ? '–°–≤–µ—Ç–ª–∞' : '–¢—ä–º–Ω–∞';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-text').textContent = '–°–≤–µ—Ç–ª–∞';
    } else {
        document.getElementById('theme-text').textContent = '–¢—ä–º–Ω–∞';
    }

    function updateClock() {
        const now  = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('bg-BG');
        document.getElementById('date').innerText  = now.toLocaleDateString('bg-BG', { day:'numeric', month:'long', year:'numeric' });
        const hour = now.getHours();
        const sd   = document.getElementById('shift-display');
        if (hour >= 7 && hour < 15)       { sd.innerText = '–ü—ä—Ä–≤–∞ —Å–º—è–Ω–∞';  sd.style.background = 'var(--accent)'; }
        else if (hour >= 15 && hour < 23) { sd.innerText = '–í—Ç–æ—Ä–∞ —Å–º—è–Ω–∞';  sd.style.background = '#f97316'; }
        else                              { sd.innerText = '–ù–æ—â–Ω–∞ —Å–º—è–Ω–∞';  sd.style.background = '#6b7280'; }
    }
    setInterval(updateClock, 1000);
    updateClock();

    const allInputs     = Array.from(document.querySelectorAll('input:not(#operator-name):not(#importFile):not(#select-all-checkbox):not(.history-checkbox)'));
    const helpModal     = document.getElementById('help-modal');
    const toast         = document.getElementById('toast');
    const operatorInput = document.getElementById('operator-name');
    const firstInput    = document.getElementById('first-input');
    const regInput      = document.getElementById('reg-in');

    function toggleHelp() {
        helpModal.style.display = helpModal.style.display === 'block' ? 'none' : 'block';
    }
    function togglePage() {
        window.scrollTo(0, window.pageYOffset > 300 ? 0 : document.body.scrollHeight);
    }

    // FIX 4 ‚Äì addEventListener instead of window.onscroll / window.onload
    window.addEventListener('scroll', function () {
        const isDown = window.pageYOffset > 300;
        document.getElementById('svgDown').style.display = isDown ? 'none'  : 'block';
        document.getElementById('svgUp').style.display   = isDown ? 'block' : 'none';
    });

    function updateDeleteButton() {
        const btn   = document.getElementById('delete-btn');
        const count = selectedRows.size;
        if (count > 0) {
            btn.innerHTML = `üóë –ò–ó–¢–†–ò–ô –ú–ê–†–ö–ò–†–ê–ù–ò–¢–ï (${count})`;
            btn.classList.add('delete-selected-btn');
        } else {
            btn.innerHTML = 'üóë –ò–ó–¢–†–ò–ô';
            btn.classList.remove('delete-selected-btn');
        }
    }

    function toggleRowSelection(checkbox, index) {
        const row = checkbox.closest('tr');
        if (checkbox.checked) { row.classList.add('history-row-selected');    selectedRows.add(index); }
        else                  { row.classList.remove('history-row-selected'); selectedRows.delete(index); }
        const allCBs     = document.querySelectorAll('.history-checkbox');
        const selectAll  = document.getElementById('select-all-checkbox');
        const allChecked = Array.from(allCBs).every(cb => cb.checked);
        selectAll.checked = allChecked;
        document.getElementById('select-all-btn').innerHTML = allChecked ? '‚úó –î–ï–ú–ê–†–ö–ò–†–ê–ô –í–°–ò–ß–ö–û' : '‚úì –ú–ê–†–ö–ò–†–ê–ô –í–°–ò–ß–ö–û';
        updateDeleteButton();
    }

    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.history-checkbox');
        const selectAll  = document.getElementById('select-all-checkbox');
        if (selectAll.checked) {
            checkboxes.forEach(cb => { cb.checked = false; cb.closest('tr').classList.remove('history-row-selected'); selectedRows.delete(cb.dataset.index); });
            selectAll.checked = false;
            document.getElementById('select-all-btn').innerHTML = '‚úì –ú–ê–†–ö–ò–†–ê–ô –í–°–ò–ß–ö–û';
        } else {
            checkboxes.forEach(cb => { cb.checked = true;  cb.closest('tr').classList.add('history-row-selected');    selectedRows.add(cb.dataset.index); });
            selectAll.checked = true;
            document.getElementById('select-all-btn').innerHTML = '‚úó –î–ï–ú–ê–†–ö–ò–†–ê–ô –í–°–ò–ß–ö–û';
        }
        updateDeleteButton();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FIX 5 ‚Äì Integer-safe floating-point accumulation
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function runCalc() {
        let cashCents = 0;
        document.querySelectorAll('.c-in').forEach(i => {
            const qty = parseInt(i.value) || 0;
            cashCents += qty * Math.round(parseFloat(i.dataset.v) * 100);
        });
        const cash = cashCents / 100;

        const p   = parseFloat(document.getElementById('plus-in').value.replace(',', '.'))  || 0;
        const m   = parseFloat(document.getElementById('minus-in').value.replace(',', '.')) || 0;
        const pos = parseFloat(document.getElementById('pos-in').value.replace(',', '.'))   || 0;
        const reg = parseFloat(document.getElementById('reg-in').value.replace(',', '.'))   || 0;

        const dayTotal = Math.round((cash - p + m + pos) * 100) / 100;
        // FIX 6 ‚Äì store diff as a number; format separately for display
        const diff     = Math.round((dayTotal - reg) * 100) / 100;

        document.getElementById('total-cash').textContent = cash.toFixed(2) + ' ‚Ç¨';
        document.getElementById('day-total').textContent  = dayTotal.toFixed(2) + ' ‚Ç¨';
        const dEl = document.getElementById('diff-display');
        dEl.textContent = (diff > 0 ? '+' : '') + diff.toFixed(2) + ' ‚Ç¨';
        dEl.className   = diff > 0 ? 'res-val diff-pos' : diff < 0 ? 'res-val diff-neg' : 'res-val';
    }

    function getCurrentShift() {
        const h = new Date().getHours();
        if (h >= 7 && h < 15)  return '–ü—ä—Ä–≤–∞';
        if (h >= 15 && h < 23) return '–í—Ç–æ—Ä–∞';
        return '–ù–æ—â–Ω–∞';
    }

    function saveHistory() {
        const operator = document.getElementById('operator-name').value.trim().substring(0, 50) || '–ì–æ—Å—Ç';
        const shift    = getCurrentShift();
        const diffText = document.getElementById('diff-display').textContent;
        const diffVal  = parseFloat(diffText) || 0;

        const report = {
            time:       new Date().toLocaleString('bg-BG', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' }),
            operator:   operator,
            shift:      shift,
            cash:       document.getElementById('total-cash').textContent,
            pos:        document.getElementById('pos-in').value || '0.00',
            reg:        document.getElementById('reg-in').value || '0.00',
            diff:       diffText,
            diffValue:  diffVal
        };

        let history = JSON.parse(localStorage.getItem('cashHistory') || '[]');
        history.unshift(report);
        localStorage.setItem('cashHistory', JSON.stringify(history));
        loadHistory();
        showToast(`‚úÖ –ó–∞–ø–∏—Å–∞–Ω–æ! (${operator}, ${shift} —Å–º—è–Ω–∞)`);
        localStorage.setItem('lastOperator', operator);
    }

    function showToast(msg) {
        toast.textContent = msg;   // textContent = XSS-safe
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 1800);
    }

    function exportToJSON() {
        const history = JSON.parse(localStorage.getItem('cashHistory') || '[]');
        if (history.length === 0) { showToast("üì≠ –ù—è–º–∞ –∏—Å—Ç–æ—Ä–∏—è –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç!"); return; }
        const blob = new Blob([JSON.stringify(history, null, 2)], { type: 'application/json' });
        const url  = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href  = url;
        link.download = `kasa_history_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
        URL.revokeObjectURL(url);
        showToast("‚úÖ –ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–Ω–æ!");
    }

    function importFromJSON(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (file.size > 1024 * 1024) { showToast("‚ö†Ô∏è –§–∞–π–ª—ä—Ç –µ —Ç–≤—ä—Ä–¥–µ –≥–æ–ª—è–º! –ú–∞–∫—Å. 1MB."); event.target.value = ''; return; }

        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (!Array.isArray(imported)) throw new Error("–ù–µ–≤–∞–ª–∏–¥–µ–Ω —Ñ–æ—Ä–º–∞—Ç");
                if (imported.length === 0) { showToast("üì≠ –§–∞–π–ª—ä—Ç –µ –ø—Ä–∞–∑–µ–Ω!"); return; }

                // FIX 3: validate + sanitize every record
                const valid = imported.filter(isValidRecord).map(sanitizeRecord);
                if (valid.length === 0) { showToast("‚ö†Ô∏è –ù–∏—Ç–æ –µ–¥–∏–Ω –≤–∞–ª–∏–¥–µ–Ω –∑–∞–ø–∏—Å!"); return; }

                showConfirm('–ò–º–ø–æ—Ä—Ç', `–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ ${valid.length} –∑–∞–ø–∏—Å–∞?`, () => {
                    let history = JSON.parse(localStorage.getItem('cashHistory') || '[]');
                    const existing = new Set(history.map(h => h.time));
                    const fresh    = valid.filter(h => !existing.has(h.time));
                    if (fresh.length === 0) { showToast("‚ÑπÔ∏è –ù—è–º–∞ –Ω–æ–≤–∏ –∑–∞–ø–∏—Å–∏!"); return; }
                    localStorage.setItem('cashHistory', JSON.stringify([...fresh, ...history]));
                    loadHistory();
                    showToast(`üìÇ –ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–∏ ${fresh.length} –∑–∞–ø–∏—Å–∞!`);
                });
            } catch (err) {
                showToast("‚ö†Ô∏è –ì—Ä–µ—à–∫–∞: " + escapeHTML(err.message));
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    // FIX 1: All fields escaped before innerHTML insertion
    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('cashHistory') || '[]');
        let html = '';
        history.forEach((h, index) => {
            const isChecked = selectedRows.has(index.toString());
            const rowClass  = isChecked ? 'history-row-selected' : '';
            const diffClass = h.diffValue > 0 ? 'diff-pos' : h.diffValue < 0 ? 'diff-neg' : '';
            html += `
                <tr class="${rowClass}" data-index="${index}">
                    <td class="checkbox-column">
                        <input type="checkbox" class="history-checkbox" data-index="${index}"
                               ${isChecked ? 'checked' : ''}
                               onchange="toggleRowSelection(this, '${index}')">
                    </td>
                    <td><b>${escapeHTML(h.time)}</b></td>
                    <td><span class="operator-badge">${escapeHTML(h.operator || '–ì–æ—Å—Ç')}</span></td>
                    <td>${escapeHTML(h.shift || '–ü—ä—Ä–≤–∞')}</td>
                    <td>${escapeHTML(h.cash)}</td>
                    <td>${escapeHTML(h.pos)} ‚Ç¨</td>
                    <td>${escapeHTML(h.reg)} ‚Ç¨</td>
                    <td class="${diffClass}">${escapeHTML(h.diff)}</td>
                </tr>`;
        });
        document.querySelector('#historyTable tbody').innerHTML = html;
        const sa = document.getElementById('select-all-checkbox');
        if (sa) sa.checked = false;
        document.getElementById('select-all-btn').innerHTML = '‚úì –ú–ê–†–ö–ò–†–ê–ô –í–°–ò–ß–ö–û';
        updateDeleteButton();
    }

    function deleteHistory() {
        if (selectedRows.size > 0) {
            showConfirm('–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ', `–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ ${selectedRows.size} –º–∞—Ä–∫–∏—Ä–∞–Ω–∏ –∑–∞–ø–∏—Å–∞?`, () => {
                let history = JSON.parse(localStorage.getItem('cashHistory') || '[]');
                Array.from(selectedRows).map(Number).sort((a,b) => b-a).forEach(i => history.splice(i,1));
                localStorage.setItem('cashHistory', JSON.stringify(history));
                const n = selectedRows.size;
                selectedRows.clear();
                loadHistory();
                showToast(`üóë –ò–∑—Ç—Ä–∏—Ç–∏ ${n} –∑–∞–ø–∏—Å–∞!`);
            });
        } else {
            showConfirm('–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ', '–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ü—è–ª–∞—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è?', () => {
                localStorage.removeItem('cashHistory');
                selectedRows.clear();
                loadHistory();
                showToast("üóë –ò—Å—Ç–æ—Ä–∏—è—Ç–∞ –µ –∏–∑—Ç—Ä–∏—Ç–∞!");
            });
        }
    }

    function clearAll() {
        allInputs.forEach(i => i.value = '');
        runCalc();
        firstInput.focus();
    }

    function deleteHistoryWithArchive() {
        const history = JSON.parse(localStorage.getItem('cashHistory') || '[]');
        if (history.length === 0) { showToast("üì≠ –ò—Å—Ç–æ—Ä–∏—è—Ç–∞ –µ –ø—Ä–∞–∑–Ω–∞."); return; }
        showConfirm('–ê—Ä—Ö–∏–≤ –∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ', `–ê—Ä—Ö–∏–≤–∏—Ä–∞–Ω–µ –∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ ${history.length} –∑–∞–ø–∏—Å–∞?`, () => {
            const now  = new Date();
            const name = `kasa_archive_${now.toLocaleDateString('bg-BG').replace(/\./g,'-')}_${now.toLocaleTimeString('bg-BG').replace(/:/g,'-')}.json`;
            const blob = new Blob([JSON.stringify(history, null, 2)], { type: 'application/json' });
            const url  = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url; link.download = name;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            URL.revokeObjectURL(url);
            setTimeout(() => {
                localStorage.removeItem('cashHistory');
                selectedRows.clear();
                loadHistory();
                showToast(`üì¶ –ê—Ä—Ö–∏–≤–∏—Ä–∞–Ω–æ! üóë –ò—Å—Ç–æ—Ä–∏—è—Ç–∞ –µ –∏–∑—Ç—Ä–∏—Ç–∞.`);
            }, 100);
        });
    }

    // FIX 1+2: printHistory uses escapeHTML for all data; no raw interpolation
    function printHistory() {
        const history = JSON.parse(localStorage.getItem('cashHistory') || '[]');
        if (history.length === 0) { showToast("–ù—è–º–∞ –∏—Å—Ç–æ—Ä–∏—è –∑–∞ –ø–µ—á–∞—Ç!"); return; }

        const operator  = escapeHTML(document.getElementById('operator-name').value || '–ì–æ—Å—Ç');
        const printDate = escapeHTML(new Date().toLocaleString('bg-BG'));
        const rows = history.map(h => {
            const dc = h.diffValue > 0 ? 'diff-pos' : h.diffValue < 0 ? 'diff-neg' : '';
            return `<tr>
                <td>${escapeHTML(h.time)}</td>
                <td><span class="operator">${escapeHTML(h.operator||'–ì–æ—Å—Ç')}</span></td>
                <td><span class="sb">${escapeHTML(h.shift||'–ü—ä—Ä–≤–∞')}</span></td>
                <td>${escapeHTML(h.cash)}</td>
                <td>${escapeHTML(h.pos)} ‚Ç¨</td>
                <td>${escapeHTML(h.reg)} ‚Ç¨</td>
                <td class="${dc}">${escapeHTML(h.diff)}</td>
            </tr>`;
        }).join('');

        const pw = window.open('', '_blank');
        if (!pw) { showToast("‚ö†Ô∏è –†–∞–∑—Ä–µ—à–µ—Ç–µ –∏–∑—Å–∫–∞—á–∞—â–∏ –ø—Ä–æ–∑–æ—Ä—Ü–∏!"); return; }
        pw.document.write(`<!DOCTYPE html><html lang="bg"><head><meta charset="UTF-8">
        <title>–ö–∞—Å–æ–≤ –æ—Ç—á–µ—Ç</title>
        <style>
            body{font-family:'Courier New',monospace;padding:15px;max-width:1000px;margin:0 auto}
            h1{text-align:center;border-bottom:1px solid #000;padding-bottom:5px;font-size:14pt;margin:5px 0}
            h2{text-align:center;color:#333;font-size:12pt;margin:5px 0}
            table{width:100%;border-collapse:collapse;margin-top:10px;font-size:8pt}
            th{background:#f0f0f0;padding:4px 3px;text-align:left;border-bottom:1px solid #000;font-size:8pt;white-space:nowrap}
            td{padding:3px;border-bottom:1px solid #ccc;font-size:8pt;white-space:nowrap}
            .operator{background:#e6f3ff;padding:2px 4px;border-radius:3px;font-size:7pt}
            .sb{background:#3b82f6;color:white;padding:1px 4px;border-radius:8px;font-size:7pt}
            .footer{margin-top:10px;text-align:center;font-size:7pt;border-top:1px solid #ccc;padding-top:5px}
            .diff-pos{color:green;font-weight:bold}.diff-neg{color:red;font-weight:bold}
            p{margin:3px 0;font-size:8pt}
            @media print{body{print-color-adjust:exact;-webkit-print-color-adjust:exact}}
        </style></head><body>
        <h1>–ö–ê–°–û–í –û–¢–ß–ï–¢</h1><h2>–ò—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏—Ç–µ</h2>
        <p><strong>–û—Ç–ø–µ—á–∞—Ç–∞–ª:</strong> ${operator}</p>
        <p><strong>–î–∞—Ç–∞ –Ω–∞ –ø–µ—á–∞—Ç:</strong> ${printDate}</p>
        <p><strong>–û–±—â–æ –∑–∞–ø–∏—Å–∞:</strong> ${history.length}</p>
        <table><thead><tr>
            <th>–î–∞—Ç–∞/–ß–∞—Å</th><th>–ö–∞—Å–∏–µ—Ä</th><th>–°–º—è–Ω–∞</th>
            <th>–í –±—Ä–æ–π</th><th>–ö–∞—Ä—Ç–∏</th><th>X-–û—Ç—á–µ—Ç</th><th>–†–∞–∑–ª–∏–∫–∞</th>
        </tr></thead><tbody>${rows}</tbody></table>
        <div class="footer">
            <p>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</p>
            <p>–ü–æ–¥–ø–∏—Å: ______________________</p>
            <p>–ö–∞—Å–æ–≤ –ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä v1.05 ¬© 2026</p>
        </div>
        <script>window.onload=()=>{window.print();window.close();}<\/script>
        </body></html>`);
        pw.document.close();
    }

    // Keyboard shortcuts
    window.addEventListener('keydown', (e) => {
        const key = e.key.toLowerCase();
        if (e.key === 'F1')                                                    { e.preventDefault(); toggleHelp(); }
        if (e.key === 'Escape') {
            if (helpModal.style.display === 'block')                           { e.preventDefault(); helpModal.style.display = 'none'; }
            else                                                               { clearAll(); }
        }
        if (e.key === 'Enter' && e.ctrlKey)                                    { e.preventDefault(); saveHistory(); }
        if (e.key === 'Enter' && !e.ctrlKey && document.activeElement === operatorInput) { e.preventDefault(); firstInput.focus(); }
        if ((key === 'p' || key === '–ø') && e.altKey && !e.ctrlKey)           { e.preventDefault(); printHistory(); }
        if (e.key === 'Insert' && e.ctrlKey)                                   { e.preventDefault(); document.getElementById('importFile').click(); }
        if ((key === 's' || key === '—Å') && e.altKey && !e.ctrlKey && !e.shiftKey) { e.preventDefault(); exportToJSON(); }
        if (e.key === 'Delete' && e.ctrlKey && !e.altKey && !e.shiftKey)      { e.preventDefault(); deleteHistoryWithArchive(); }
        if (e.key === 'PageUp')   { e.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
        if (e.key === 'PageDown') { e.preventDefault(); window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }
    });

    // Input validation
    allInputs.forEach((input) => {
        if (input.classList.contains('c-in')) {
            input.addEventListener('input', (e) => { e.target.value = e.target.value.replace(/[^0-9]/g, ''); runCalc(); });
        } else {
            input.addEventListener('input', (e) => {
                let val = e.target.value.replace(/[^0-9.,]/g, '');
                if ((val.match(/\./g)||[]).length > 1 || (val.match(/,/g)||[]).length > 1) {
                    const ls = Math.max(val.lastIndexOf('.'), val.lastIndexOf(','));
                    if (ls > -1) val = val.substring(0, ls) + '.' + val.substring(ls+1).replace(/[.,]/g,'');
                }
                if (val.includes('.') || val.includes(',')) {
                    val = val.replace(',', '.');
                    const p = val.split('.');
                    if (p.length > 1) val = p[0] + '.' + p[1].substring(0,2);
                }
                e.target.value = val; runCalc();
            });
        }
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.ctrlKey) {
                e.preventDefault();
                if (document.activeElement === regInput) { firstInput.focus(); }
                else {
                    const ci = allInputs.findIndex(i => i === document.activeElement);
                    if (ci >= 0 && ci < allInputs.length - 1) allInputs[ci+1].focus();
                }
            }
        });
    });

    // FIX 4: window.addEventListener instead of window.onload
    window.addEventListener('load', () => {
        loadHistory();
        operatorInput.focus();
        operatorInput.select();
        const last = localStorage.getItem('lastOperator');
        if (last) operatorInput.value = last.substring(0, 50);
        operatorInput.addEventListener('change', function () {
            localStorage.setItem('lastOperator', this.value.substring(0, 50));
        });
        updateDeleteButton();
    });
</script>
</body>
</html>

