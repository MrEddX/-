<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <title>–ö–∞—Å–æ–≤ –ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä Pro - –°–º–µ–Ω–∏</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #334155;
            --accent: #3b82f6;
            --border: #e2e8f0;
            --header-bg: #ffffff;
            --hover-bg: #f1f5f9;
            --shadow: 0 10px 40px rgba(0,0,0,0.06);
            --btn-save-bg: #dcfce7;
            --btn-save-text: #16a34a;
            --btn-save-border: #bbf7d0;
            --btn-clear-bg: #fee2e2;
            --btn-clear-text: #dc2626;
            --btn-clear-border: #fecaca;
            --operator-bg: #f8fafc;
        }

        .dark-mode {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
            --accent: #60a5fa;
            --border: #334155;
            --header-bg: #1e293b;
            --hover-bg: #2d3a4f;
            --shadow: 0 10px 40px rgba(0,0,0,0.3);
            --btn-save-bg: #14532d;
            --btn-save-text: #86efac;
            --btn-save-border: #166534;
            --btn-clear-bg: #7f1d1d;
            --btn-clear-text: #fca5a5;
            --btn-clear-border: #991b1b;
            --operator-bg: #1e293b;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            scroll-behavior: smooth;
            transition: background-color 0.3s ease, color 0.2s ease;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 40px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            color: var(--text);
            z-index: 1001;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.05);
            background: var(--hover-bg);
        }

        .theme-toggle .sun { display: inline; }
        .theme-toggle .moon { display: none; }
        .dark-mode .theme-toggle .sun { display: none; }
        .dark-mode .theme-toggle .moon { display: inline; }

        .page-calc {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .app-container {
            background: var(--card);
            padding: 25px 35px;
            border-radius: 24px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 1100px;
            border: 1px solid var(--border);
            transition: background-color 0.3s ease, border-color 0.2s ease;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
        }

        .dark-mode header {
            border-bottom: 2px solid var(--border);
        }

        #clock {
            font-size: 1.4em;
            font-weight: 800;
            color: var(--accent);
        }

        /* –ü–æ–ª–µ –∑–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä - –ø–æ-–Ω–µ–Ω–∞—Ç—Ä–∞–ø—á–∏–≤–æ */
        .operator-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 8px 12px;
            background: var(--operator-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
        }

        .operator-row label {
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #64748b;
        }

        .operator-row input {
            width: 200px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-weight: normal;
            font-size: 0.95em;
            background: var(--bg);
            color: var(--text);
        }

        .operator-row input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .shift-badge {
            background: var(--accent);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1.3fr;
            gap: 25px;
        }

        .column {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .col-header {
            font-size: 0.75em;
            font-weight: 800;
            color: #94a3b8;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .row {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--card);
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .label {
            flex: 1;
            font-weight: 700;
            font-size: 0.95em;
        }

        input {
            width: 85px;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            background: var(--bg);
            color: var(--text);
            transition: all 0.2s ease;
        }

        .dark-mode input {
            border: 1px solid var(--border);
        }

        input:focus {
            outline: none;
            border-color: var(--accent);
            background: #f0f7ff;
        }

        .dark-mode input:focus {
            background: var(--hover-bg);
        }

        .b500 { border-left: 6px solid #a29bfe; background: #f5f3ff; }
        .b200 { border-left: 6px solid #fbc531; background: #fffbeb; }
        .b100 { border-left: 6px solid #4cd137; background: #f0fdf4; }
        .b50 { border-left: 6px solid #e67e22; background: #fff7ed; }
        .b20 { border-left: 6px solid #3498db; background: #eff6ff; }
        .b10 { border-left: 6px solid #e84118; background: #fef2f2; }
        .b5 { border-left: 6px solid #95a5a6; background: #f8fafc; }
        .gold { border-left: 6px solid #d4af37; background: #fffdf0; }
        .copper { border-left: 6px solid #b87333; background: #fff7f2; }

        .dark-mode .b500 { background: #2d2b4a; }
        .dark-mode .b200 { background: #3d3a24; }
        .dark-mode .b100 { background: #1d3a2a; }
        .dark-mode .b50 { background: #3d3422; }
        .dark-mode .b20 { background: #1d3347; }
        .dark-mode .b10 { background: #3d2427; }
        .dark-mode .b5 { background: #2d3338; }
        .dark-mode .gold { background: #3d3925; }
        .dark-mode .copper { background: #3d2e26; }

        .right-panel {
            background: #f8fafc;
            padding: 18px;
            border-radius: 18px;
            border: 1px solid var(--border);
        }

        .dark-mode .right-panel {
            background: var(--card);
        }

        .extra-box { margin-bottom: 12px; }
        .special-label {
            font-size: 0.75em;
            font-weight: 700;
            display: block;
            margin-bottom: 4px;
        }

        .full-in {
            width: 100% !important;
            box-sizing: border-box;
            padding: 10px;
            font-size: 1.3em;
        }

        .summary-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f1f5f9;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .dark-mode .summary-footer {
            border-top: 2px solid var(--border);
        }

        .stat-card {
            padding: 12px;
            border-radius: 15px;
            border: 1px solid var(--border);
            background: var(--card);
            text-align: center;
        }

        .res-val {
            font-size: 1.8em;
            font-weight: 900;
        }

        .diff-pos { color: #16a34a; }
        .diff-neg { color: #dc2626; }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
        }

        .btn {
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            border: 1px solid transparent;
            transition: 0.2s;
            font-size: 0.9em;
        }

        .btn-save {
            background: var(--btn-save-bg);
            color: var(--btn-save-text);
            border-color: var(--btn-save-border);
        }

        .btn-clear {
            background: var(--btn-clear-bg);
            color: var(--btn-clear-text);
            border-color: var(--btn-clear-border);
        }

        #help-modal, #toast {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            z-index: 1000;
            border: 2px solid var(--accent);
            color: var(--text);
        }

        #toast {
            padding: 20px 40px;
            border-color: #16a34a;
            color: #16a34a;
            font-weight: bold;
            font-size: 1.2em;
            text-align: center;
        }

        .dark-mode #toast {
            background: var(--card);
        }

        .kb-key {
            background: #f1f5f9;
            padding: 2px 8px;
            border-radius: 5px;
            border: 1px solid #cbd5e1;
            font-family: monospace;
            font-weight: bold;
        }

        .dark-mode .kb-key {
            background: var(--hover-bg);
            border-color: var(--border);
        }

        .nav-hint {
            position: fixed;
            right: 30px;
            bottom: 30px;
            background: var(--card);
            padding: 12px;
            border-radius: 50%;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            z-index: 100;
            cursor: pointer;
        }

        .page-history {
            min-height: 100vh;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 60px 20px;
            border-top: 4px solid var(--accent);
        }

        .history-container {
            width: 100%;
            max-width: 1200px;
        }

        .scroll-box {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 15px;
            margin-top: 20px;
            background: var(--card);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            position: sticky;
            top: 0;
            background: var(--card);
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid var(--border);
            color: var(--text);
            font-size: 0.9em;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            font-size: 0.85em;
            white-space: nowrap;
        }

        .operator-badge {
            background: var(--accent);
            color: white;
            padding: 2px 6px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: bold;
            display: inline-block;
        }

        #importFile { display: none; }

        @media print {
            .page-calc, .nav-hint, .btn-group, .theme-toggle, #help-modal, #toast, .history-container button {
                display: none !important;
            }
            .page-history {
                border: none;
                padding: 0;
                background: white;
            }
            .scroll-box {
                max-height: none;
                overflow: visible;
                border: none;
            }
            table { 
                font-size: 9pt; 
                border: 1px solid #eee; 
                width: 100%;
            }
            th, td { 
                color: black; 
                padding: 4px 6px;
                font-size: 8pt;
                white-space: nowrap;
            }
            .print-operator {
                font-size: 10pt;
                margin-bottom: 5px;
            }
            .operator-badge {
                font-size: 7pt;
                padding: 1px 4px;
            }
        }
    </style>
</head>
<body>

<div class="theme-toggle" onclick="toggleTheme()">
    <span class="sun">üåô</span>
    <span class="moon">‚òÄÔ∏è</span>
    <span id="theme-text">–¢—ä–º–Ω–∞</span>
</div>

<div id="help-modal">
    <h3 style="margin-top:0">‚å®Ô∏è –®–æ—Ä—Ç–∫—ä—Ç–∏</h3>
    <p><span class="kb-key">Enter</span> - –û—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä –∫—ä–º 500‚Ç¨ –ø–æ–ª–µ</p>
    <p><span class="kb-key">Enter</span> - –°–ª–µ–¥–≤–∞—â–æ –ø–æ–ª–µ (–≤ –Ω–æ–º–∏–Ω–∞–ª–∏—Ç–µ)</p>
    <p><span class="kb-key">Enter</span> - –û—Ç X-–û—Ç—á–µ—Ç –∫—ä–º 500‚Ç¨ –ø–æ–ª–µ</p>
    <p><span class="kb-key">Ctrl + Enter</span> - –ó–∞–ø–∏—Å –≤ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</p>
    <p><span class="kb-key">Esc</span> - –ó–∞—Ç–≤–æ—Ä–∏ –ø–æ–º–æ—â—Ç–∞ / –ò–∑—á–∏—Å—Ç–∏</p>
    <p><span class="kb-key">F1</span> - –ü–æ–º–æ—â</p>
    <p><span class="kb-key">P</span> - –ü—Ä–∏–Ω—Ç–∏—Ä–∞–π –∏—Å—Ç–æ—Ä–∏—è</p>
    <p><span class="kb-key">Ctrl + Insert</span> - –ò–º–ø–æ—Ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è</p>
    <p><span class="kb-key">Ctrl + Delete</span> - –ï–∫—Å–ø–æ—Ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è</p>
    <p><span class="kb-key">Page Up</span> - –ö—ä–º –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä–∞ ‚¨ÜÔ∏è</p>
    <p><span class="kb-key">Page Down</span> - –ö—ä–º –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ ‚¨áÔ∏è</p>
    <button onclick="toggleHelp()" style="width:100%; padding:10px; cursor:pointer; border-radius:10px; background: var(--accent); color: white; border: none; font-weight: bold;">–ó–∞—Ç–≤–æ—Ä–∏</button>
</div>

<div id="toast">‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è—Ç–∞ –µ —É—Å–ø–µ—à–Ω–∞!</div>

<div id="btnNav" class="nav-hint" onclick="togglePage()">
    <svg id="svgDown" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M7 13l5 5 5-5M7 6l5 5 5-5"/></svg>
    <svg id="svgUp" style="display:none" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M17 11l-5-5-5 5M17 18l-5-5-5 5"/></svg>
</div>

<div class="page-calc">
    <div class="app-container">
        <header>
            <h2 style="margin:0">üí∂ –ö–∞—Å–æ–≤–∞ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç <span style="font-size:0.4em; opacity:0.4">–ü–æ–º–æ—â (F1)</span></h2>
            <div style="text-align:right">
                <div id="date" style="font-size:0.8em; color:#64748b">-- -- ----</div>
                <div id="clock">00:00:00</div>
            </div>
        </header>

        <!-- –ü–æ–ª–µ –∑–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä - –Ω–µ–Ω–∞—Ç—Ä–∞–ø—á–∏–≤–æ -->
        <div class="operator-row">
            <label>
                <span>–û–ø–µ—Ä–∞—Ç–æ—Ä / –ö–∞—Å–∏–µ—Ä:</span>
                <input type="text" id="operator-name" placeholder="–ò–º–µ –Ω–∞ –∫–∞—Å–∏–µ—Ä–∞" value="–ì–æ—Å—Ç">
            </label>
            <span class="shift-badge" id="shift-display">–ü—ä—Ä–≤–∞ —Å–º—è–Ω–∞</span>
        </div>

        <div class="main-grid">
            <div class="column">
                <div class="col-header">–ë–∞–Ω–∫–Ω–æ—Ç–∏</div>
                <div class="row b500"><span class="label">500 ‚Ç¨</span><input type="text" id="first-input" class="c-in" data-v="500"></div>
                <div class="row b200"><span class="label">200 ‚Ç¨</span><input type="text" class="c-in" data-v="200"></div>
                <div class="row b100"><span class="label">100 ‚Ç¨</span><input type="text" class="c-in" data-v="100"></div>
                <div class="row b50"><span class="label">50 ‚Ç¨</span><input type="text" class="c-in" data-v="50"></div>
                <div class="row b20"><span class="label">20 ‚Ç¨</span><input type="text" class="c-in" data-v="20"></div>
                <div class="row b10"><span class="label">10 ‚Ç¨</span><input type="text" class="c-in" data-v="10"></div>
                <div class="row b5"><span class="label">5 ‚Ç¨</span><input type="text" class="c-in" data-v="5"></div>
            </div>
            <div class="column">
                <div class="col-header">–ú–æ–Ω–µ—Ç–∏</div>
                <div class="row gold"><span class="label">2 ‚Ç¨</span><input type="text" class="c-in" data-v="2"></div>
                <div class="row gold"><span class="label">1 ‚Ç¨</span><input type="text" class="c-in" data-v="1"></div>
                <div class="row gold"><span class="label">0.50 ‚Ç¨</span><input type="text" class="c-in" data-v="0.5"></div>
                <div class="row gold"><span class="label">0.20 ‚Ç¨</span><input type="text" class="c-in" data-v="0.2"></div>
                <div class="row gold"><span class="label">0.10 ‚Ç¨</span><input type="text" class="c-in" data-v="0.1"></div>
                <div class="row copper"><span class="label">0.05 ‚Ç¨</span><input type="text" class="c-in" data-v="0.05"></div>
                <div class="row copper"><span class="label">0.02 ‚Ç¨</span><input type="text" class="c-in" data-v="0.02"></div>
                <div class="row copper"><span class="label">0.01 ‚Ç¨</span><input type="text" class="c-in" data-v="0.01"></div>
            </div>
            <div class="column right-panel">
                <div class="col-header">–ö–æ—Ä–µ–∫—Ü–∏–∏</div>
                <div class="extra-box"><span class="special-label" style="color:#16a34a">–ü–ª—é—Å (+):</span><input type="text" id="plus-in" class="full-in"></div>
                <div class="extra-box"><span class="special-label" style="color:#dc2626">–ú–∏–Ω—É—Å (-):</span><input type="text" id="minus-in" class="full-in"></div>
                <div class="extra-box"><span class="special-label" style="color:#6366f1">POS (–ü–ª–∞—â–∞–Ω–∏—è —Å –∫–∞—Ä—Ç–∞):</span><input type="text" id="pos-in" class="full-in"></div>
                <div class="extra-box"><span class="special-label" style="color:var(--accent)">X-–û—Ç—á–µ—Ç (–ë–µ–∑ –Ω—É–ª–∏—Ä–∞–Ω–µ):</span><input type="text" id="reg-in" class="full-in"></div>
                <div class="btn-group">
                    <button class="btn btn-save" onclick="saveHistory()">–ó–ê–ü–ò–®–ò</button>
                    <button class="btn btn-clear" onclick="clearAll()">–ò–ó–ß–ò–°–¢–ò</button>
                </div>
            </div>
        </div>
        <div class="summary-footer">
            <div class="stat-card"><span class="special-label">–í –ë—Ä–æ–π:</span><span class="res-val" id="total-cash">0.00 ‚Ç¨</span></div>
            <div class="stat-card"><span class="special-label">–û–±—â –û–±–æ—Ä–æ—Ç:</span><span class="res-val" id="day-total">0.00 ‚Ç¨</span></div>
            <div class="stat-card"><span class="special-label">–†–∞–∑–ª–∏–∫–∞:</span><span class="res-val" id="diff-display">0.00 ‚Ç¨</span></div>
        </div>
    </div>
</div>

<div class="page-history">
    <div class="history-container">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 15px;">
            <h2 style="margin:0">üìú –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –æ—Ç—á–µ—Ç–∏—Ç–µ</h2>
            <div>
                <button onclick="exportToJSON()" style="cursor:pointer; background:#e0f2fe; border:1px solid #bae6fd; padding: 8px 12px; border-radius: 8px; color:#0369a1; font-weight: bold;">‚¨á –ï–ö–°–ü–û–†–¢</button>
                <button onclick="document.getElementById('importFile').click()" style="cursor:pointer; background:#fef9c3; border:1px solid #fde047; padding: 8px 12px; border-radius: 8px; color:#854d0e; font-weight: bold;">üìÇ –ò–ú–ü–û–†–¢</button>
                <button onclick="printHistory()" style="cursor:pointer; background:#f1f5f9; border:1px solid #cbd5e1; padding: 8px 12px; border-radius: 8px; color:#334155; font-weight: bold;">üñ® –ü–†–ò–ù–¢</button>
                <button onclick="deleteHistory()" style="cursor:pointer; background:#fff1f2; border:1px solid #fecdd3; padding: 8px 12px; border-radius: 8px; color:#be123c; font-weight: bold;">üóë –ò–ó–¢–†–ò–ô</button>
                <input type="file" id="importFile" accept=".json" onchange="importFromJSON(event)">
            </div>
        </div>
        <div class="scroll-box">
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞ / –ß–∞—Å</th>
                        <th>–ö–∞—Å–∏–µ—Ä</th>
                        <th>–°–º—è–Ω–∞</th>
                        <th>–í –±—Ä–æ–π</th>
                        <th>–ö–∞—Ä—Ç–∏</th>
                        <th>X-–û—Ç—á–µ—Ç</th>
                        <th>–†–∞–∑–ª–∏–∫–∞</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // –¢—ä–º–Ω–∞ —Ç–µ–º–∞
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const themeText = document.getElementById('theme-text');
        themeText.textContent = document.body.classList.contains('dark-mode') ? '–°–≤–µ—Ç–ª–∞' : '–¢—ä–º–Ω–∞';
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }

    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-text').textContent = '–°–≤–µ—Ç–ª–∞';
    } else {
        document.getElementById('theme-text').textContent = '–¢—ä–º–Ω–∞';
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('bg-BG');
        document.getElementById('date').innerText = now.toLocaleDateString('bg-BG', { day:'numeric', month:'long', year:'numeric' });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ —Å–º—è–Ω–∞ —Å–ø–æ—Ä–µ–¥ —á–∞—Å–∞
        const hour = now.getHours();
        const shiftDisplay = document.getElementById('shift-display');
        if (hour >= 7 && hour < 15) {
            shiftDisplay.innerText = '–ü—ä—Ä–≤–∞ —Å–º—è–Ω–∞';
            shiftDisplay.style.background = 'var(--accent)';
        } else if (hour >= 15 && hour < 23) {
            shiftDisplay.innerText = '–í—Ç–æ—Ä–∞ —Å–º—è–Ω–∞';
            shiftDisplay.style.background = '#f97316';
        } else {
            shiftDisplay.innerText = '–ù–æ—â–Ω–∞ —Å–º—è–Ω–∞';
            shiftDisplay.style.background = '#6b7280';
        }
    }
    setInterval(updateClock, 1000); updateClock();

    const allInputs = Array.from(document.querySelectorAll('input:not(#operator-name)'));
    const helpModal = document.getElementById('help-modal');
    const toast = document.getElementById('toast');
    const operatorInput = document.getElementById('operator-name');
    const firstInput = document.getElementById('first-input');
    const regInput = document.getElementById('reg-in');

    function toggleHelp() { 
        helpModal.style.display = helpModal.style.display === 'block' ? 'none' : 'block'; 
    }
    
    function togglePage() { 
        window.scrollTo(0, window.pageYOffset > 300 ? 0 : document.body.scrollHeight); 
    }

    window.onscroll = function() {
        const isDown = window.pageYOffset > 300;
        document.getElementById('svgDown').style.display = isDown ? 'none' : 'block';
        document.getElementById('svgUp').style.display = isDown ? 'block' : 'none';
    };

    function runCalc() {
        let cash = 0;
        // –ë–∞–Ω–∫–Ω–æ—Ç–∏ –∏ –º–æ–Ω–µ—Ç–∏ - —Å–∞–º–æ —Ü–µ–ª–∏ —á–∏—Å–ª–∞
        document.querySelectorAll('.c-in').forEach(i => { 
            const val = parseInt(i.value) || 0;
            cash += val * parseFloat(i.dataset.v); 
        });
        
        // –ö–æ—Ä–µ–∫—Ü–∏–∏ - –¥—Ä–æ–±–Ω–∏ —á–∏—Å–ª–∞ —Å . –∏–ª–∏ ,
        let p = parseFloat(document.getElementById('plus-in').value.replace(',', '.')) || 0;
        let m = parseFloat(document.getElementById('minus-in').value.replace(',', '.')) || 0;
        let pos = parseFloat(document.getElementById('pos-in').value.replace(',', '.')) || 0;
        let reg = parseFloat(document.getElementById('reg-in').value.replace(',', '.')) || 0;
        
        let dayTotal = cash + p - m + pos;
        let diff = dayTotal - reg;
        
        document.getElementById('total-cash').innerText = cash.toFixed(2) + ' ‚Ç¨';
        document.getElementById('day-total').innerText = dayTotal.toFixed(2) + ' ‚Ç¨';
        const dEl = document.getElementById('diff-display');
        dEl.innerText = (diff > 0 ? '+' : '') + diff.toFixed(2) + ' ‚Ç¨';
        
        // –û—Ü–≤–µ—Ç—è–≤–∞–Ω–µ: –∑–µ–ª–µ–Ω–æ –∑–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª–Ω–æ, —á–µ—Ä–≤–µ–Ω–æ –∑–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª–Ω–æ
        if (diff > 0) {
            dEl.className = 'res-val diff-pos';
        } else if (diff < 0) {
            dEl.className = 'res-val diff-neg';
        } else {
            dEl.className = 'res-val';
        }
    }

    function getCurrentShift() {
        const hour = new Date().getHours();
        if (hour >= 7 && hour < 15) return '–ü—ä—Ä–≤–∞';
        if (hour >= 15 && hour < 23) return '–í—Ç–æ—Ä–∞';
        return '–ù–æ—â–Ω–∞';
    }

    function saveHistory() {
        const operator = document.getElementById('operator-name').value.trim() || '–ì–æ—Å—Ç';
        const shift = getCurrentShift();
        
        const report = {
            time: new Date().toLocaleString('bg-BG', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}),
            operator: operator,
            shift: shift,
            cash: document.getElementById('total-cash').innerText,
            pos: document.getElementById('pos-in').value || '0.00',
            reg: document.getElementById('reg-in').value || '0.00',
            diff: document.getElementById('diff-display').innerText
        };
        
        let history = JSON.parse(localStorage.getItem('cashHistory') || '[]');
        history.unshift(report);
        localStorage.setItem('cashHistory', JSON.stringify(history));
        loadHistory();
        showToast(`‚úÖ –ó–∞–ø–∏—Å–∞–Ω–æ! (${operator}, ${shift} —Å–º—è–Ω–∞)`);
        
        localStorage.setItem('lastOperator', operator);
    }

    function showToast(msg) {
        toast.innerText = msg; toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 1500);
    }

    function exportToJSON() {
        const history = JSON.parse(localStorage.getItem('cashHistory') || '[]');
        if (history.length === 0) return alert("–ù—è–º–∞ –∏—Å—Ç–æ—Ä–∏—è –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç!");
        
        const dataStr = JSON.stringify(history, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `kasa_history_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showToast("‚úÖ –ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–Ω–æ!");
    }

    function importFromJSON(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (!Array.isArray(imported)) throw new Error("–ù–µ–≤–∞–ª–∏–¥–µ–Ω —Ñ–æ—Ä–º–∞—Ç");
                if (imported.length === 0) return alert("–§–∞–π–ª—ä—Ç –µ –ø—Ä–∞–∑–µ–Ω!");
                
                if (confirm(`–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ ${imported.length} –∑–∞–ø–∏—Å–∞?`)) {
                    let history = JSON.parse(localStorage.getItem('cashHistory') || '[]');
                    const existingTimes = new Set(history.map(h => h.time));
                    const newRecords = imported.filter(h => !existingTimes.has(h.time));
                    
                    if (newRecords.length === 0) return alert("–ù—è–º–∞ –Ω–æ–≤–∏ –∑–∞–ø–∏—Å–∏!");
                    
                    let combined = [...newRecords, ...history];
                    localStorage.setItem('cashHistory', JSON.stringify(combined));
                    loadHistory();
                    showToast(`üìÇ –ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–∏ ${newRecords.length} –∑–∞–ø–∏—Å–∞!`);
                }
            } catch (error) {
                alert("–ì—Ä–µ—à–∫–∞: " + error.message);
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('cashHistory') || '[]');
        document.querySelector('#historyTable tbody').innerHTML = history.map(h => `
            <tr>
                <td><b>${h.time}</b></td>
                <td><span class="operator-badge">${h.operator || '–ì–æ—Å—Ç'}</span></td>
                <td>${h.shift || '–ü—ä—Ä–≤–∞'}</td>
                <td>${h.cash}</td>
                <td>${h.pos} ‚Ç¨</td>
                <td>${h.reg} ‚Ç¨</td>
                <td class="${h.diff.includes('+')?'diff-pos':h.diff.includes('-')?'diff-neg':''}">${h.diff}</td>
            </tr>
        `).join('');
    }

    function deleteHistory() { 
        if(confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ü—è–ª–∞—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è?")) { 
            localStorage.removeItem('cashHistory'); 
            loadHistory(); 
            showToast("üóë –ò—Å—Ç–æ—Ä–∏—è—Ç–∞ –µ –∏–∑—Ç—Ä–∏—Ç–∞!");
        } 
    }
    
    function clearAll() { 
        allInputs.forEach(i => i.value = ''); 
        runCalc(); 
        firstInput.focus(); 
    }

    function printHistory() {
        const operator = document.getElementById('operator-name').value || '–ì–æ—Å—Ç';
        const history = JSON.parse(localStorage.getItem('cashHistory') || '[]');
        
        if (history.length === 0) {
            alert("–ù—è–º–∞ –∏—Å—Ç–æ—Ä–∏—è –∑–∞ –ø–µ—á–∞—Ç!");
            return;
        }

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>–ö–∞—Å–æ–≤ –æ—Ç—á–µ—Ç - –ò—Å—Ç–æ—Ä–∏—è</title>
                    <style>
                        body { font-family: 'Courier New', monospace; padding: 15px; max-width: 1000px; margin: 0 auto; }
                        h1 { text-align: center; border-bottom: 1px solid #000; padding-bottom: 5px; font-size: 14pt; margin: 5px 0; }
                        h2 { text-align: center; color: #333; font-size: 12pt; margin: 5px 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 8pt; }
                        th { background: #f0f0f0; padding: 4px 3px; text-align: left; border-bottom: 1px solid #000; font-size: 8pt; white-space: nowrap; }
                        td { padding: 3px 3px; border-bottom: 1px solid #ccc; font-size: 8pt; white-space: nowrap; }
                        .operator { background: #e6f3ff; padding: 2px 4px; border-radius: 3px; font-size: 7pt; }
                        .footer { margin-top: 10px; text-align: center; font-size: 7pt; border-top: 1px solid #ccc; padding-top: 5px; }
                        .diff-pos { color: green; font-weight: bold; }
                        .diff-neg { color: red; font-weight: bold; }
                        .shift-badge-print { background: #3b82f6; color: white; padding: 1px 4px; border-radius: 8px; font-size: 7pt; }
                        p { margin: 3px 0; font-size: 8pt; }
                        @media print {
                            body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <h1>üí∞ –ö–ê–°–û–í –û–¢–ß–ï–¢</h1>
                    <h2>–ò—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏—Ç–µ</h2>
                    
                    <p><strong>–û—Ç–ø–µ—á–∞—Ç–∞–ª:</strong> ${operator}</p>
                    <p><strong>–î–∞—Ç–∞ –Ω–∞ –ø–µ—á–∞—Ç:</strong> ${new Date().toLocaleString('bg-BG')}</p>
                    <p><strong>–û–±—â–æ –∑–∞–ø–∏—Å–∞:</strong> ${history.length}</p>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞/–ß–∞—Å</th>
                                <th>–ö–∞—Å–∏–µ—Ä</th>
                                <th>–°–º—è–Ω–∞</th>
                                <th>–í –±—Ä–æ–π</th>
                                <th>–ö–∞—Ä—Ç–∏</th>
                                <th>X-–û—Ç—á–µ—Ç</th>
                                <th>–†–∞–∑–ª–∏–∫–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${history.map(h => `
                                <tr>
                                    <td>${h.time}</td>
                                    <td><span class="operator">${h.operator || '–ì–æ—Å—Ç'}</span></td>
                                    <td><span class="shift-badge-print">${h.shift || '–ü—ä—Ä–≤–∞'}</span></td>
                                    <td>${h.cash}</td>
                                    <td>${h.pos} ‚Ç¨</td>
                                    <td>${h.reg} ‚Ç¨</td>
                                    <td class="${h.diff.includes('+') ? 'diff-pos' : (h.diff.includes('-') ? 'diff-neg' : '')}">${h.diff}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</p>
                        <p>–ü–æ–¥–ø–∏—Å: ______________________</p>
                        <p>¬© –ö–∞—Å–æ–≤ –ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä Pro</p>
                    </div>
                    
                    <script>
                        window.onload = () => { window.print(); window.close(); }
                    <\/script>
                </body>
            </html>
        `);
        printWindow.document.close();
    }

    window.addEventListener('keydown', (e) => {
        const key = e.key.toLowerCase();
        
        if (e.key === 'F1') { 
            e.preventDefault(); 
            toggleHelp(); 
        }
        
        if (e.key === 'Escape') { 
            if (helpModal.style.display === 'block') {
                e.preventDefault();
                helpModal.style.display = 'none';
            } else {
                clearAll();
            }
        }
        
        if (e.key === 'Enter' && e.ctrlKey) { 
            e.preventDefault(); 
            saveHistory(); 
        }
        
        if (e.key === 'Enter' && !e.ctrlKey) { 
            // Enter –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä
            if (document.activeElement === operatorInput) {
                e.preventDefault();
                firstInput.focus();
            }
        }
        
        if (key === 'p' && !e.ctrlKey && !e.altKey) { 
            e.preventDefault(); 
            printHistory(); 
        }
        
        // Ctrl + Insert –∑–∞ –∏–º–ø–æ—Ä—Ç
        if (e.key === 'Insert' && e.ctrlKey) { 
            e.preventDefault(); 
            document.getElementById('importFile').click(); 
        }
        
        // Ctrl + Delete –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç
        if (e.key === 'Delete' && e.ctrlKey) { 
            e.preventDefault(); 
            exportToJSON(); 
        }
        
        if (e.key === 'PageUp') { 
            e.preventDefault(); 
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        if (e.key === 'PageDown') { 
            e.preventDefault(); 
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }
    });

    // –†–∞–∑–ª–∏—á–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞ —Ä–∞–∑–ª–∏—á–Ω–∏—Ç–µ –ø–æ–ª–µ—Ç–∞
    allInputs.forEach((input, idx) => {
        // –ó–∞ –±–∞–Ω–∫–Ω–æ—Ç–∏ –∏ –º–æ–Ω–µ—Ç–∏ (c-in –∫–ª–∞—Å) - —Å–∞–º–æ —Ü–µ–ª–∏ —á–∏—Å–ª–∞
        if (input.classList.contains('c-in')) {
            input.addEventListener('input', (e) => { 
                e.target.value = e.target.value.replace(/[^0-9]/g, ''); 
                runCalc(); 
            });
        } 
        // –ó–∞ –∫–æ—Ä–µ–∫—Ü–∏–∏ (plus-in, minus-in, pos-in, reg-in) - –¥—Ä–æ–±–Ω–∏ —Å . –∏–ª–∏ , –∏ –º–∞–∫—Å–∏–º—É–º 2 –∑–Ω–∞–∫–∞ —Å–ª–µ–¥ –¥–µ—Å–µ—Ç–∏—á–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª
        else {
            input.addEventListener('input', (e) => { 
                // –ó–∞–ø–∞–∑–≤–∞–º–µ —Ü–∏—Ñ—Ä–∏, —Ç–æ—á–∫–∞ –∏ –∑–∞–ø–µ—Ç–∞—è
                let val = e.target.value.replace(/[^0-9.,]/g, '');
                
                // –ù–æ—Ä–º–∞–ª–∏–∑–∏—Ä–∞–º–µ - –∞–∫–æ –∏–º–∞ –∏ –¥–≤–µ—Ç–µ, –ø–æ—Å–ª–µ–¥–Ω–∞—Ç–∞ —Ç–æ—á–∫–∞/–∑–∞–ø–µ—Ç–∞—è –ø–µ—á–µ–ª–∏
                if ((val.match(/\./g) || []).length > 1 || (val.match(/,/g) || []).length > 1) {
                    const lastDot = val.lastIndexOf('.');
                    const lastComma = val.lastIndexOf(',');
                    const lastSep = Math.max(lastDot, lastComma);
                    if (lastSep > -1) {
                        val = val.substring(0, lastSep) + '.' + val.substring(lastSep + 1).replace(/[.,]/g, '');
                    }
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–∞–≤–∞–º–µ –¥–æ 2 –∑–Ω–∞–∫–∞ —Å–ª–µ–¥ –¥–µ—Å–µ—Ç–∏—á–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª
                if (val.includes('.') || val.includes(',')) {
                    // –ó–∞–º–µ–Ω—è–º–µ –∑–∞–ø–µ—Ç–∞—è —Å —Ç–æ—á–∫–∞ –∑–∞ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–∞–Ω–µ
                    val = val.replace(',', '.');
                    const parts = val.split('.');
                    if (parts.length > 1) {
                        // –ê–∫–æ –∏–º–∞ –¥–µ—Å–µ—Ç–∏—á–Ω–∏ –∑–Ω–∞—Ü–∏, –æ—Å—Ç–∞–≤—è–º–µ —Å–∞–º–æ –ø—ä—Ä–≤–∏—Ç–µ –¥–≤–∞
                        const integerPart = parts[0];
                        const decimalPart = parts[1].substring(0, 2);
                        val = integerPart + '.' + decimalPart;
                    }
                }
                
                e.target.value = val;
                runCalc(); 
            });
        }
        
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.ctrlKey) { 
                e.preventDefault(); 
                
                // –ê–∫–æ —Å–º–µ –Ω–∞ X-–û—Ç—á–µ—Ç (–ø–æ—Å–ª–µ–¥–Ω–æ—Ç–æ –ø–æ–ª–µ)
                if (document.activeElement === regInput) {
                    firstInput.focus();
                }
                // –ê–∫–æ –∏–º–∞ —Å–ª–µ–¥–≤–∞—â–æ –ø–æ–ª–µ, –æ—Ç–∏–≤–∞–º–µ –Ω–∞ –Ω–µ–≥–æ
                else {
                    const currentIndex = allInputs.findIndex(inp => inp === document.activeElement);
                    if (currentIndex >= 0 && currentIndex < allInputs.length - 1) {
                        allInputs[currentIndex + 1].focus();
                    }
                }
            }
        });
    });

    window.onload = () => { 
        loadHistory(); 
        // –§–æ–∫—É—Å –≤—ä—Ä—Ö—É –ø–æ–ª–µ—Ç–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
        operatorInput.focus();
        operatorInput.select();
        
        const lastOperator = localStorage.getItem('lastOperator');
        if (lastOperator) {
            document.getElementById('operator-name').value = lastOperator;
        }
        
        document.getElementById('operator-name').addEventListener('change', function() {
            localStorage.setItem('lastOperator', this.value);
        });
    };
</script>
</body>
</html>